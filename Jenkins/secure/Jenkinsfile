def template = '''
apiVersion: v1
kind: Pod
metadata:
  labels:
    run: kaniko
  name: kaniko
spec:
  serviceAccountName: jenkins-kaniko
  containers:
  - name: nodejs
    image: node:18-alpine
    command:
    - cat
    tty: true
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "256Mi"
        cpu: "300m"
  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    command:
    - /busybox/cat
    tty: true
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "300m"
  - name: docker
    image: docker:24-dind
    securityContext:
      privileged: true
    command:
    - dockerd-entrypoint.sh
    tty: true
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "300m"
  - name: aws-cli
    image: amazon/aws-cli:latest
    command:
    - cat
    tty: true
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "200m"
'''

properties([
    parameters([
        string(
            name: 'IMAGE_NAME',
            defaultValue: 'web',
            description: 'Image name'
        ),
        string(
            name: 'ECR_REPO',
            defaultValue: 'nodejs-nyan-app-jenkins',
            description: 'ECR repository base name'
        ),
        string(
            name: 'AWS_REGION',
            defaultValue: 'us-east-1',
            description: 'AWS region for ECR repository'
        )
    ])
])



podTemplate(cloud: 'kubernetes', label: 'kaniko', yaml: template) {
    node("kaniko") {
        
        stage("Checkout SCM") {
            container("nodejs") {
                git branch: 'main', url: 'https://github.com/K8-Team/web.git'
            }
        }
        
        stage("Run Tests") {
            container("nodejs") {
                sh """
                if [ ! -f "package.json" ]; then
                    echo "ERROR: package.json not found"
                    exit 1
                fi
                
                npm install --production
                
                if [ -f "index.js" ]; then
                    node -c index.js || exit 1
                elif [ -f "server.js" ]; then
                    node -c server.js || exit 1
                elif [ -f "app.js" ]; then
                    node -c app.js || exit 1
                fi
                
                if grep -q '\\"test\\"' package.json; then
                    npm test || true
                fi
                """
            }
        }

        withCredentials([string(credentialsId: 'aws-creds', variable: 'AWS_ACCOUNT_ID')]) {
                
                stage("Create ECR Repository") {
                    container("aws-cli") {
                        sh """
                        export AWS_REGION=${params.AWS_REGION}
                        export ECR_REPO_FULL=${params.ECR_REPO}/${params.IMAGE_NAME}
                        
                        if ! aws ecr describe-repositories --repository-names "\${ECR_REPO_FULL}" --region "\${AWS_REGION}" 2>/dev/null; then
                            aws ecr create-repository \\
                                --repository-name "\${ECR_REPO_FULL}" \\
                                --region "\${AWS_REGION}" \\
                                --image-scanning-configuration scanOnPush=true \\
                                --encryption-configuration encryptionType=AES256
                            echo "Repository created: \${ECR_REPO_FULL}"
                        fi
                        """
                    }
                }
                
                stage("Build Image") {
                    container("kaniko") {
                        sh """
                    export AWS_REGION=${params.AWS_REGION}
                    export ECR_REPO_FULL=${params.ECR_REPO}/${params.IMAGE_NAME}
                    export ECR_REGISTRY=${AWS_ACCOUNT_ID}.dkr.ecr.\${AWS_REGION}.amazonaws.com
                    
                    /kaniko/executor \\
                      --context=\${WORKSPACE} \\
                      --dockerfile=Dockerfile \\
                      --destination=\${ECR_REGISTRY}/\${ECR_REPO_FULL}:${BUILD_NUMBER}-test \\
                      --cache=true \\
                      --cache-ttl=24h
                        """
                    }
                }
                
                stage("Test Docker Image") {
                    container("docker") {
                        sh """
                        export AWS_REGION=${params.AWS_REGION}
                        export ECR_REPO_FULL=${params.ECR_REPO}/${params.IMAGE_NAME}
                        export ECR_REGISTRY=${AWS_ACCOUNT_ID}.dkr.ecr.\${AWS_REGION}.amazonaws.com
                        export TEST_IMAGE=\${ECR_REGISTRY}/\${ECR_REPO_FULL}:${BUILD_NUMBER}-test
                        
                        sleep 5
                        aws ecr get-login-password --region \${AWS_REGION} | docker login --username AWS --password-stdin \${ECR_REGISTRY}
                        docker pull \${TEST_IMAGE}
                        docker inspect \${TEST_IMAGE} --format='Size: {{.Size}} bytes'
                        
                        CONTAINER_ID=\$(docker run -d \${TEST_IMAGE})
                        sleep 5
                        
                        if docker ps | grep -q \${CONTAINER_ID}; then
                            docker logs \${CONTAINER_ID}
                            docker stop \${CONTAINER_ID} || true
                        else
                            echo "ERROR: Container failed to start"
                            docker logs \${CONTAINER_ID} || true
                            exit 1
                        fi
                        
                        docker rm \${CONTAINER_ID} || true
                        """
                    }
                }
                
                stage("Push to ECR") {
                    container("aws-cli") {
                        sh """
                        export AWS_REGION=${params.AWS_REGION}
                        export ECR_REPO_FULL=${params.ECR_REPO}/${params.IMAGE_NAME}
                        export ECR_REGISTRY=${AWS_ACCOUNT_ID}.dkr.ecr.\${AWS_REGION}.amazonaws.com
                        
                        MANIFEST=\$(aws ecr batch-get-image \\
                            --repository-name \${ECR_REPO_FULL} \\
                            --image-ids imageTag=${BUILD_NUMBER}-test \\
                            --region \${AWS_REGION} \\
                            --query 'images[0].imageManifest' \\
                            --output text)
                        
                        aws ecr put-image \\
                            --repository-name \${ECR_REPO_FULL} \\
                            --image-tag ${BUILD_NUMBER} \\
                            --image-manifest "\${MANIFEST}" \\
                            --region \${AWS_REGION}
                        
                        aws ecr put-image \\
                            --repository-name \${ECR_REPO_FULL} \\
                            --image-tag latest \\
                            --image-manifest "\${MANIFEST}" \\
                            --region \${AWS_REGION}
                        
                        aws ecr batch-delete-image \\
                            --repository-name \${ECR_REPO_FULL} \\
                            --image-ids imageTag=${BUILD_NUMBER}-test \\
                            --region \${AWS_REGION}
                        """
                    }
                }
        }
    }
}
